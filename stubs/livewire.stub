<?php

namespace [namespace];

use Livewire\Component;
use WireUi\Traits\Actions;
use Illuminate\Support\Str;
use Livewire\Attributes\On;
use [model_import];
use [action_import];
use [request_import];

class [class] extends Component
{
    use Actions;

    private $viewForm     = '[module]::[model_low_case].form';
    private $table        = '[module]::[model_low_case].table';
    private $refreshTable = 'refreshTable';
    public  $formTitle    = '[title]';
    public  $resetForm    = 'resetForm';

    public $formType = 'modal', $formModal, $state, $disable = false, $softDelete = false, $forceDelete = false, $dataId;
    public [fields];
    public $resetFields = ['forceDelete', 'state', [resetFields]];

    protected function rules()
    {
        return (new [request]($this->dataId))->rules();
    }

    protected function validationAttributes(): array
    {
        return (new [request]($this->dataId))->attributes();
    }

    public function mount($formType = 'modal', $data = NULL)
    {
        $this->formType = $formType;
        if ($data) {
            $this->show($data);
        }
    }

    #[On('resetForm')]
    public function resetForm()
    {
        $this->clearValidation();
        if ($this->formType == 'modal') {
            $this->reset($this->resetFields);
            $this->dataId = Str::orderedUuid()->toString();
        }
        $this->disable = true;
    }

    #[On('create')]
    public function create()
    {
        $this->resetForm();
        $this->disable = false;
    }

    #[On('setData')]
    public function setData()
    {
        $this->clearValidation();
        $this->disable   = true;
        $this->dataId    = $this->state->id;
        [setData]
    }

    #[On('show')]
    public function show([model] $data)
    {
        $this->state = $data;
        $this->setData();
    }

    public function render()
    {
        if ($this->formType == 'modal')
            return view('partials.form-modal', ['modalName' => 'formModal', 'width' => '2xl', 'view' => $this->viewForm]);
        if ($this->formType == 'card')
            return view('partials.form-card', ['view' => $this->viewForm]);
    }

    private function _notif($message, $icon)
    {
        $this->notification([
            'title'       => NULL,
            'description' => $message,
            'icon'        => $icon
        ]);
        if ($icon == 'success') {
            $this->resetForm();
            $this->formModal = false;
            $this->dispatch($this->refreshTable)->to($this->table);
            $this->dispatch('saved');
        }
    }

    public function save([action] $action)
    {
        $validatedData = $this->validate((new [request]($this->dataId))->rules());
        try {
            $action->save($validatedData);
            $this->_notif('Data berhasil disimpan', 'success');
        } catch (\Exception $e) {
            $this->_notif($e->getMessage(), 'error');
        }
    }

    public function delete([action] $action, $id)
    {
        try {
            $action->delete($id, $this->forceDelete);
            $this->_notif('Data berhasil dihapus', 'success');
        } catch (\Exception $e) {
            $this->_notif($e->getMessage(), 'error');
        }
    }
}